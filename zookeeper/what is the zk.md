
# Zookeeper
## overview
Zookeeper服务于分布式系统，主要用来做：统一配置管理，统一命名服务，分布式锁，集群管理。
## zk的数据结构
zk能干这么多事情和它的数据结构有关系，zk的数据结构跟Unix文件系统类似，可以看做是一棵树，每个节点叫ZNode。
![zk数据结构](/asset/zk数据结构.png)
ZNode有两种类型：
* 临时节点：当客户端与服务端断开连接后，创建的ZNode会自动删除。
  * 普通临时节点
  * 带序号的临时节点
* 持久节点：断开连接后不会删除。
  * 普通持久节点
  * 普通带序号的临时节点
## 监听器
ZNode配合监听器，就可以做很多事情了。监听的场景主要有两个：
* 监听ZNode的数据变化
* 监听子节点的数量变化

## 分布式锁
在分布式环境下，一个服务部署在多个pod节点上，节点A,B,C都都需要先访问/lock文件
![zk-lock](/asset/zk-lock.png)
访问文件后每个pod节点都会创建一个临时/有序的ZNode：
![](/asset/zk-lock-2.png)
加锁时，拿到/lock下的所有子节点，判断自己是不是最小的节点
* 如果是，拿到锁（执行完成后删除自己的节点）
* 如果不是，监听自己前一个节点的变化

上面的图中：
* A拿到/lock下的所有子节点，发现自己的顺序是最小的，拿到锁执行
* B拿到子节点后发现自己不是最小的，监听自己的前一个（00000001 Node）
* C同理
zk做分布式锁伪代码
```java
public void lock() {
    if (tryLock()) {
        
    }
}
```
## 集群状态
